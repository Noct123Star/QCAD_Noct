# QCAD Project 相关说明

预操作：

使用VisualStudio打开项目，右击项目属性，将项目锁使用的QT版本更改为当前电脑中所安装的QT版本。

点击上方Git，将项目添加至仓库

![image-20241002174517540](C:\Users\Local_MS\AppData\Roaming\Typora\typora-user-images\image-20241002174517540.png)

在GitHubDesktop中add repository，

![image-20241002175024934](C:\Users\Local_MS\AppData\Roaming\Typora\typora-user-images\image-20241002175024934.png)

右击项目-属性-链接器-系统，将子系统更改为控制台（方便查看）

![image-20241002175213511](C:\Users\Local_MS\AppData\Roaming\Typora\typora-user-images\image-20241002175213511.png)

## 保存

在`mainwindow.cpp`中的`saveFile()`中编写相关代码。

1.添加保存的代码：

保存当前图元数量。针对EntityList中的每个图元，保存当前图元的类型EntityType，调用`MEntity`类的`Serialize(QDataStream& ar, bool bSave)`方法将EntityList中的各个图元对象串行化保存。由于使用 QDataStream 类，因为数据保存结果为二进制文件。

```c++
void MainWindow::saveFile(){
    // 保存为
    int EntityNum = view->GetEntityList().size();
    out << EntityNum;
    EEntityType EnType;
    foreach(MEntity * pEnt, view->GetEntityList()) {
        EnType = (EEntityType)pEnt->GetType();
        out << EnType;
        switch (EnType) {
        case EEntityType::etLine:
            MLine* line = (MLine*)pEnt;
            line->Serialize(out, true);
            break;
        }
    }
    std::cout << "文档保存成功." << '\n';
}
```

2.添加保存格式选择：`.cad`

```c++
void MainWindow::saveFile(){
    if (m_sFileName == tr("untitled"))
	{
        QString sName = QFileDialog::getSaveFileName(this, tr("Save Picture"), "", "CAD(*.cad)");
        if (sName.isEmpty())
        {
            return;
        }
        m_sFileName = sName;
	}
}
```

3.修改ENTITY.CPP中的`Serialize(QDataStream& ar, bool bSave)`代码：

代码后端存在未初始化的变量被赋值的情况，直接调用会报错。所以将后段赋值操作置入反串行化的读取内容中。

```c++
void MEntity::Serialize(QDataStream& ar, bool bSave)
{
	int			 lineWidth;
	Qt::PenStyle lineStyle;
	int intStyle;
	QColor  	color;

	if (bSave)
		ar << m_pen.color() << m_pen.style() << m_pen.width();
	else
	{
		ar >> color >> intStyle >> lineWidth;

		lineStyle = (Qt::PenStyle)intStyle;
		m_pen = QPen(color);
		m_pen.setWidth(lineWidth);
		m_pen.setStyle(lineStyle);
	}
}
```

## 另存

在`mainwindow.cpp`中的`saveAsFile()`中编写相关代码。

代码内容与`saveFile()`基本一致，但减少了检查文档命名的if判定，直接提示输入文件名并选择保存的位置。

```c++
void MainWindow::saveAsFile()
{
    //提示输入文件名
    QString sName = QFileDialog::getSaveFileName(this, tr("Save Picture"), "", "CAD(*.cad)");
    if (sName.isEmpty())
    {
        return;
    }
    m_sFileName = sName;
    //将内存内容保存到文档中
    QFile file(m_sFileName);
    if (!file.open(QIODevice::ReadWrite))
    {
        qDebug() << "open file failed";
        return;
    }
    QDataStream out(&file);
    //scene->Save(out);
    int EntityNum = view->GetEntityList().size();
    out << EntityNum;
    EEntityType EnType;
    foreach(MEntity * pEnt, view->GetEntityList()) {
        EnType = (EEntityType)pEnt->GetType();
        out << EnType;
        switch (EnType) {
        case EEntityType::etLine:
            MLine* line = (MLine*)pEnt;
            line->Serialize(out, true);
            break;
        }
    }
    std::cout << "文档保存成功." << '\n';
    file.close();
    return;
}
```

## 读取

1.清空内存

在QCADView.cpp中添加EntityList的清空函数，在`openFile()`中调用。

```c++
void QCADView::clearList()
{
	foreach(MEntity * pEnt, m_EntityList)
	{
		if (pEnt)
		{
			m_EntityList.removeOne(pEnt);
			delete pEnt;
			pEnt = nullptr;
			qDebug() << "EntityList size--" << m_EntityList.size();
		}
	}
	m_EntityList.clear();
}
```

2.读取文件

依据上述各个数据在`saveFile()`中的保存顺序，依次读取图元数、图元类型、图元的成员等内容。

```c++
void MainWindow::openFile()
{
    int nCount;
    in >> nCount;
    for (int i = 0; i < nCount; i++) {
        int EnType;
        MLine* line;
        in >> EnType;
        switch (EnType)
        {
        case EEntityType::etLine:
            line = new MLine();
            line->Serialize(in, false);
            view->addEntity(line);
            break;
        }
    }
    std::cout << "文档读取成功." << '\n';
}
```

> 注：目前存储与读取的基本功能能够大致实现，不过作业QCAD文档中还有“检查当前有没有文档，且发生更改？”的内容，不太清楚这一块的含义总用。